# 页面介绍 

##  时间栏及时间选择界面

如Fig.2.所示，左侧提供时间选择栏（Fig.2.A）可以手动选择时间范围，筛选该事件范围内的帖子。点击时间框后弹出时间选择框，时间选择框最上方显示选中日期和时间，中部是日历，点击具体日期可以选中对应日期，下方两个按键"now"对应返回当下时间，"OK"表示确认选中。

##  帖子主题 
B区域显示帖子对应的主题内容。

## 帖子及评论展示部分
C区域显示每个帖子的时间戳、帖子ID、用户名和用户ID、文本内容和评论数量。此区域可以通过鼠标滚动查看帖子内容并可点击帖子查看其评论。

## 按照标签筛选
输入框（D），允许用户输入话题标签搜索此话题标签下的帖子。

## 时间轴
时间轴（E）以条形图形式显示，展示事件期间讨论热度的整体趋势，横坐标为时间，纵坐标为热度。

用户可以将鼠标悬停在任何条形元素上查看具体帖子的内容和网址。

用户可以向列表中添加突发新闻并高亮显示。通过在时间轴上右键单击任意点会弹出输入框，可以输入事件内容，点击确定按键后创建相应事件，点击E区第一行蓝色的"save"案件保存事件，显示弹窗"事件已保存"。

用户可以通过刷选横轴底部的时间线更新显示和分析的数据范围。刷选横轴对应时间段后，点击"set"按键，只显示选中时间段的帖子和其热度。点击"reset"按键显示全部帖子。

最左侧的红色按键"clear"用于清除坐标轴上选中的帖子。

## 复选框
系统通过复选框（F）模块化功能，选定的功能界面显示在下方。这种设计确保在保持界面清晰和布局合理的同时实现必要的分析功能。

### 环境设置
复选框内第一个选项"set up"为环境设置组件。勾选这个选项后在F区下面显示的页面如Fig.3.左侧第一个任务框所示。

在其最上面显示开始时间和结束时间，允许用户勾选模拟的开始和结束时间，时间勾选页面同A区。

用户可以通过上传加载JSON文件重用之前的模拟结果。

通过滑动情感、立场、规模三个滑条，用户可以在有限的模拟时间内进一步筛选源数据，并根据其倾向调整帖子被选中的概率。

系统还支持设置事件的简要描述，存储为自然语言文本，在模拟过程中提供给智能体作为其对事件的初始理解。可以通过在"事件介绍"下的输入框内输入对事件的介绍实现。

点击"保存"后，模拟的基础数据（即模拟环境）被存储，最终选中的帖子数量显示在下方。通过这些设置，用户可以修改事件的整体规模并调整情绪和立场偏见，从而为模拟创建不同的事件背景。

### 智能体设置

复选框内第二个选项"agent"点击后展示的界面如Fig.3.中间任务框所示。

界面允许用户配置智能体何时加入讨论并开始影响环境，可以通过选择开始时间决定，时间选择页面同A区。

界面最上方KOL一栏可以设定智能体是否为意见领袖（其帖子更有可能被查看并在交互中具有更大权重）。

性格一栏可以定义智能体的属性和个性。这些设置包括智能体是否立场坚定（需要更强的信息刺激才能改变其观点）、智能体是否过滤对立观点（决定其如何处理具有不同观点的帖子和用户）以及智能体是否为活跃用户（影响发帖频率）。用户可以通过选择是否态度坚定，是否屏蔽不同意见，是否活跃三个选项栏设置智能体。为了模拟真实社交媒体用户，每个智能体在加入时具有定义的情绪、立场和立场信心水平。用户可以通过选择情感是正面、中性还是负面，立场是患者、中立还是医院，拖动滑条调整立场确信度。

【算法说明】
后端立场相似度算法采用 group=1→0.0（支持患者），0→0.5（中立），2→1.0（支持医院）的对称映射，agent.stance为0~1的浮点数，二者距离越近相似度越高。

点击下方"添加"按钮后在右侧显示创建的智能体，智能体显示内容和格式如Fig.3.最右侧所示，用户可以滚动浏览智能体，可以点击每个智能体显示框显示的"删除"按钮删除特定智能体。

点击"添加"下方的"模拟"按钮后，智能体和环境设置被发送至后端以启动模拟过程。

### 直方图

F区复选框内第三个选项"histogram"选中后显示直方图，如Fig.4. a所示，横坐标为时间，纵坐标为热度。与时间轴类似，直方图显示在时间轴上选中时间段内发布的帖子热门度随时间的变化。

帖子按顺序排列时，横轴编码其顺序而非具体时间戳。

用户可以通过按钮在按时间或热门度排序帖子之间切换，点击"sort"按键即可切换，从而专注于高参与度的核心信息。

为调整信息密度，默认隐藏转发内容，但可根据用户需求包含。

此外，可以点击"stem only"按键，滑动点击后在"stem only"右侧显示的滑条设置最低热门度阈值以过滤显示的帖子。

用户可以将鼠标悬停在任意直方上，会显示文字框给出帖子用户名、内容、热度、日期和时间。

### 折线图饼图

F区复选框内第四个选项"attitude"选中后显示直方图群体情绪和立场（Fig.4. b）组件结合折线图和饼图，可视化情绪、立场和讨论随时间的变化。

在E区域时间轴上选定时间段内的情绪指标通过对所有帖子按其信息强度加权求和获得。

每个饼图元素在横轴上编码时间，纵轴上编码情绪，正值和负值分别代表积极和消极情绪。半径编码该时间范围内的整体讨论规模，而饼图的面积代表持有不同立场的用户比例。

用户可以调整时间范围为任意整数小时或天数，以在不同时间粒度下分析数据。用户可以通过选择"count by hour"还是"count by day"，然后拖动选项旁边的滑条选择划分小时数或天数。

### 词云图

F区复选框内第五个选项"word cloud"选中后显示"generate"按键，鼠标点击后显示词云（Fig.4. c）。

词云用于分析帖子的语义信息，帮助揭示文本数据中的重要关键词及其相对权重，突出讨论的主题。每个词的字体大小与其在E区时间轴上选定时间段内发布帖子文本中出现的频率成正比。

### 折线图

F区复选框内第七个选项"single"选中后显示Fig.4. d。每个智能体的数据都以折线图形式可视化，横轴表示时间，纵轴表示情感，节点颜色表示立场变化。

悬停在节点上将显示该时间片的信息，包括智能体ID、情感指标、立场指标以及智能体在该时间片浏览的帖子。

此外，由智能体生成的模拟数据被纳入可视化。这些智能体的群体指标使用绿色方形元素呈现。横轴表示单个时间片，纵轴编码群体情绪偏差。元素的颜色显示群体的立场偏差。

### 转发树

F区复选框内第六个选项"tree"选中后显示Fig.4. e转发树。可视化事件传播过程中消息扩散的层次结构。每个节点的半径编码其转发级别。虚拟节点作为视图中心的根节点，每层帖子向外排列。

模拟结束后，数据被重新加载，模拟期间智能体发布的帖子在树中高亮显示。

此外，智能体浏览的帖子在转发树中高亮显示，帮助识别情感和立场变化的关键转折点。鼠标悬停在高亮节点可以显示微博ID，微博内容，转发数和总转发数。

【说明】当前系统不启用兴趣匹配，所有Agent对所有内容均不过滤兴趣，推送仅受热度和立场相似度影响。

---

## 信息强度权重机制设计说明

### 设计背景
基于论文中"信息强度"概念，将原有的硬性过滤门槛改为影响权重机制，实现更符合现实的信息处理方式。

### 核心设计理念

#### 1. 信息强度过滤 vs 影响权重
**传统方式**：使用热度阈值硬性过滤，强度不够的帖子直接被忽略。

**新设计**：
- **智能过滤**：只过滤 `strength` 为 `null` 的帖子（内容无法分析或无足轻重）
- **权重影响**：`strength` 值（1.0, 2.0, 3.0）作为影响权重，强度越高的帖子影响越大
- **避免数据损失**：充分利用所有有效帖子，避免大量内容被忽视

#### 2. 置信度更新逻辑完善
**改进前**：置信度变化只考虑兴趣匹配和热度。

**新设计**：
- **立场一致性判断**：基于立场相似度区分帖子与Agent立场是否一致
- **差异化影响**：
  - 立场一致：帖子强度越高，置信度提升越多
  - 立场不一致：帖子强度越高，对置信度的削弱也越厉害（但幅度稍小）

#### 3. 筛选逻辑优化
**个性化信息流生成**：
- 移除硬性热度阈值过滤
- 只过滤 `strength` 为 `null` 的帖子
- 保留立场相似度、兴趣匹配、黑名单过滤
- 排序权重：`heat * strength`（综合权重）

### 技术实现

#### 数据结构
```python
# 帖子数据结构中的strength字段
{
    "strength": 1.0,  # 信息强度：1.0(弱), 2.0(中), 3.0(强), null(无意义)
    "heat": 50,       # 热度值
    "stance": 1,      # 立场：1(支持患者), 0(中立), 2(支持医院)
    # ... 其他字段
}
```

#### 影响计算
```python
# 信息强度权重应用
strength_weight = float(post_strength)  # 1.0, 2.0, 3.0 直接作为权重

# 情绪变化
emotion_change = base_emotion_change * strength_weight

# 置信度变化（区分立场一致性）
if stance_similarity > 0.5:  # 立场一致
    confidence_change = base_confidence_change * strength_weight
else:  # 立场不一致
    confidence_change = -base_confidence_change * 0.6 * strength_weight
```

### 设计优势

#### 1. 符合现实行为
- 现实中人们并非完全不看"分量较轻"的新闻，只是这些新闻对他们思想的改变较小
- 信息强度权重机制能很好地模拟这一点

#### 2. 充分利用数据
- 充分利用了 1, 2, 3 这三个数值等级的差异
- 避免了将强度值粗暴地二分为"通过/不通过"

#### 3. 符合论文逻辑
- 与论文中"按信息强度加权求和"的思想完全一致
- 将宏观的群体情绪计算思想应用到微观的个体更新上

#### 4. 避免数据损失
- 移除了硬性热度阈值过滤，避免大量有效帖子被忽视
- 只过滤真正无意义的 `null` 值帖子

### 用户体验影响
- **更丰富的交互**：用户可以看到更多样化的帖子内容
- **更真实的模拟**：Agent行为更符合现实的信息处理方式
- **更精确的影响**：信息强度差异能更精确地反映在Agent状态变化中

### Agent情绪更新机制

系统支持两种情绪更新方案：

1. **LLM建议融合算法**
   - 通过prompt将Agent当前情绪、帖子内容、事件描述传递给大语言模型，获得建议情绪值（-1~1）。
   - 用公式融合：E_new = E_current × (1 - α × I_strength) + E_suggested × (α × I_strength)
   - α为Agent情绪敏感度，I_strength为帖子影响力。
   - 适合需要大模型推理的场景。

2. **纯规则算法**
   - 直接用帖子预处理阶段标记的情绪值（-1~1）作为建议情绪。
   - 用同样的融合公式。
   - 适合无需大模型推理、只用数据标签的场景。

**切换方式**：Agent初始化时设置emotion_update_mode参数（"llm"或"rule"）。

### 推送与过滤算法设计

1. **无效帖子过滤**：仅保留情绪、立场、强度均不为None的帖子。
2. **黑名单过滤**：Agent不会浏览其blocked_users中的用户所发帖子。
3. **观点屏蔽机制**：每个Agent有opinion_blocking_degree（0.0=完全开放，1.0=完全封闭），立场容忍度阈值T_stance=2.0*(1.0-opinion_blocking_degree)，仅浏览与自身立场差异不超过T_stance的帖子。
4. **相关性分数**：Score_Rel = max(0, 1.0 - abs(agent.stance - post.stance))。
5. **热度分数（对数归一化）**：Score_Pop = log(1+totalChildren)/log(1+max_totalChildren)。
6. **最终分数**：Final_Score = w_pop * Score_Pop + w_rel * Score_Rel。
7. **推送排序**：按Final_Score降序排序，推送前N个帖子。

#### 逐帖概率门控推送模型
- 对每个候选帖子，先计算Final_Score。
- 用Sigmoid函数将Final_Score转为浏览概率：P_view = 1/(1+exp(-k*(Final_Score-x0)))。
  - k为斜率参数，控制概率曲线陡峭程度。
  - x0为中心点，通常取所有Final_Score的均值或中位数。
- 对每个帖子独立采样，若随机数R<P_view，则推送该帖。
- 这样高分帖子更易被推送，但低分也有机会，推送数量自然浮动。
- 优点：更贴近真实社交体验，鲁棒性强，参数可调。
- 缺点：推送数量不固定，需关注极端分布时的表现。

#### 立场更新算法设计
- 变量：
  - agent.stance（当前立场，-1~1）
  - agent.confidence（置信度，0~1）
  - agent.attitude_stability（Enum: FIRM/UNCERTAIN）
  - agent.attitude_firmness（0~1，0.5为分界）
  - post['stance']（帖子立场，-1~1）
  - post['strength']（信息强度，0~1）
- 坚定型Agent（attitude_stability==FIRM或attitude_firmness>=0.5）：
  - 信息强度<THRESHOLD_PROCESS，置信度随机扰动（-0.02~0.02）。
  - 立场一致，置信度+DELTA_CONF_SMALL。
  - 立场不一致且信息强度>=THRESHOLD_CHANGE，立场反转，置信度-DELTA_CONF_LARGE。
  - 立场不一致且信息强度<THRESHOLD_CHANGE，置信度-DELTA_CONF_SMALL。
- 不坚定型Agent（attitude_stability==UNCERTAIN且attitude_firmness<0.5）：
  - 信息强度>=THRESHOLD_PROCESS，直接采纳新立场，置信度=信息强度。
  - 信息强度<THRESHOLD_PROCESS，置信度-DELTA_CONF_SMALL。
- 相关参数：THRESHOLD_PROCESS, THRESHOLD_CHANGE, DELTA_CONF_SMALL, DELTA_CONF_LARGE，均可调优。

#### Agent发帖与广播信息属性设定

##### Agent发帖属性设定
- emotion_score = agent.emotion
- stance_score = agent.stance
- information_strength = (abs(agent.emotion) + agent.confidence) / 2
- popularity_score = 0.0（普通用户）或 SYSTEM_OPINION_LEADER_POP_BONUS（意见领袖，默认0.7）

##### 广播信息（大新闻）属性设定
- emotion_score, stance_score 由用户指定
- information_strength = 1.0
- popularity_score = 1.0
- is_broadcast/is_event = True

##### 广播信息强制注入机制
- 每个Agent生成Feed时，若有广播信息，强制插入agent_feed最前面，跳过所有过滤和概率门控，确保全员接收。
- 其余帖子仍按常规过滤和概率门控推送。

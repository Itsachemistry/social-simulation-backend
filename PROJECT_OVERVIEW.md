---

### **你的核心任务：构建仿真引擎 (The Simulation Engine)**

你的使命是创建一个稳定、可扩展的后端服务。这个服务能够接收一个初始的"世界"配置（包含帖子数据和角色设定），然后驱动这个"世界"按照预设的规则演化，并记录下整个演化过程中的所有关键数据，最终将这些数据提供给前端进行可视化。

---

### **模块一：时间与流程管理器 (The Time & Flow Manager)**

这是你的"导演椅"和"场记板"，负责控制整个仿真的宏观节奏。

* **1.1 实现时间片机制 (Time Slice Mechanism)**
    * **职责**: 你需要设计一个机制来管理"时间"。
    * **具体工作**:
        * [cite_start]读取初始的帖子数据，根据时间戳对所有帖子进行排序 [cite: 158]。
        * [cite_start]根据设定的规模（比如每50个帖子），将这些有序的帖子划分成一个个独立的"时间片 (Time Slice)" [cite: 159]。
        * 你要维护一个指向"当前时间片"的指针，驱动仿真从一个时间片前进到下一个。

* **1.2 搭建主仿真循环 (Main Simulation Loop)**
    * **职责**: 这是你后端程序的核心骨架，一个循环体，每循环一次，就处理一个时间片。
    * **具体工作**:
        * 在每个时间片的开始，你需要准备好当前时间片内的所有环境信息。
        * 在循环体内，你会调用**模块三（Agent控制器）**来依次处理每个Agent的行动。
        * 在时间片结束时，你需要收集本轮生成的新帖子，并将它们放入一个临时的"待发布区"，准备在下一个时间片中加入主帖子池。
        * **重要提示**：考虑到仿真过程可能耗时较长，启动仿真的主循环应设计为**异步任务**，以避免阻塞用户界面。

---

### **模块二：世界状态管理器 (The World State Manager)**

这是你的"摄影棚"和"道具库"，负责管理仿真世界中所有非Agent的公共资源。

* **2.1 维护动态帖子池 (Dynamic Post Pool)**
    * **职责**: 管理整个舆论场中所有可见的帖子。
    * **具体工作**:
        * 你需要一个核心的数据结构（比如一个列表或数据库表）来存储所有的帖子对象。
        * [cite_start]这个池子是动态的：它初始时包含了真实世界的数据，在仿真过程中，由Agent生成的新帖子会不断被添加进来 [cite: 161, 186]。
        * 你需要为每篇帖子维护一些动态属性，比如"热度"，这个值可能会随着被浏览、被转发而变化。

* **2.2 实现全局事件注入器 (Global Event Injector)**
    * [cite_start]**职责**: 根据论文描述，系统需要支持引入"突发公共事件" [cite: 106]。
    * **具体工作**:
        * 你需要设计一个机制，允许通过API在特定的时间点（或时间片）向帖子池中强制插入一条高权重的"突发新闻"帖子。
        * [cite_start]这条新闻需要被标记，以确保所有Agent都能接收到它，从而模拟重大新闻对舆论的冲击效应 [cite: 106, 197]。

---

### **模块三：Agent控制器 (The Agent Controller)**

这是你的"演员调度中心"，是你与你队友（Agent设计师）工作结合最紧密的地方。

* **3.1 Agent的初始化与生命周期管理**
    * **职责**: 在仿真开始时，加载所有Agent的配置，并创建它们的实例（对象）。
    * **具体工作**:
        * 通过**模块四**提供的配置服务，获取预设的Agent配置。
        * 根据配置文件，使用你队友提供的`Agent`类，批量创建出所有参与仿真的Agent对象，并存储起来（比如放在一个列表或字典里）。
        * 你要为每个Agent分配唯一的ID。

* **3.2 实现行动顺序调度器 (Turn-based Scheduler)**
    * **具体工作**:
        * 你首先要识别出哪些是"意见领袖"，让他们先行动。
        * 然后是"基于规则的Agent"。
        * 最后是大量的"普通用户Agent"。
        * **重要**：意见领袖需要接收两种信息：
            * **环境摘要**：当前时间片内所有帖子的情感和立场信息汇总，形成宏观舆情反馈。
            * **个性化信息流**：与普通Agent相同的具体帖子筛选结果。

* **3.3 实现环境摘要生成器 (Environmental Summary Generator)**
    * **具体工作**:
        * 为意见领袖生成"环境摘要"，包含：
            * 当前时间片内所有帖子的情感分布统计
            * 立场分布统计
            * 热点话题识别
            * 整体舆论风向分析
        * 这个摘要帮助意见领袖把握宏观舆情，做出更具策略性的决策。

* **3.4 实现个性化信息流生成器 (Personalized Feed Generator)**
    * **职责**: 这是你后端最复杂也最核心的逻辑之一。你必须为每个Agent模拟出它在社交媒体上"刷到的信息流"。
    * **具体工作**:
        * 当轮到某个Agent行动时，你不能把"世界状态管理器"里的所有帖子都给它。
        * 你需要从帖子池中，根据帖子的**热度**和**发帖人与当前Agent的立场相似度**进行加权筛选，为该Agent生成一个数量有限的、个性化的"待浏览列表"。
        * 同时，你需要检查这个Agent的"黑名单"，确保被拉黑的用户的帖子不会出现在这个列表里。

* **3.5 执行Agent的核心交互逻辑 (Action Execution)**
    * **职责**: 这是你作为"总导演"与"演员"对话的场景。
    * **具体工作**:
        * 对于意见领袖：先提供环境摘要，再提供个性化信息流。
        * 对于普通Agent：只提供个性化信息流。
        * 调用Agent的 `update_state()` 方法，让它"阅读"这些信息。
        * 调用Agent的 `generate_action_prompt()` 方法，询问它是否要发言。
        * 如果Agent决定发言，你需要调用**模块四的LLM服务**来生成实际的帖子内容。
        * 将生成的帖子添加到**模块二的世界状态管理器**中。

---

### **模块四：通用服务层 (The Services Layer)**

这是你的"后勤与通讯部门"，负责处理所有与外部世界（前端、数据库、LLM）的连接和数据存取。

* **4.1 实现数据与配置服务 (Data & Configuration Service)**
    * **职责**: 负责仿真开始前的数据加载、清洗，并为前端提供完整的配置管理接口。
    * **具体工作**:
        * **数据加载与预处理**:
            * [cite_start]读取并解析包含真实世界帖子数据的JSON文件 [cite: 89]。
            * 实现数据清洗逻辑，处理无效数据。
            * 提供接口供标注模块使用，存储标注后的情感、立场等信息。
        * **前端配置API**:
            * **环境配置API**: 提供接口让前端可以设置和修改仿真环境（如时间范围、初始舆论偏向、事件规模、背景描述）。
            * **Agent配置API**: 提供完整的CRUD（增删改查）接口，让前端可以动态管理本次仿真中所有Agent的配置。

* **4.2 实现LLM服务连接器 (LLM Service Connector)**
    * **职责**: 专门负责和LLM API打交道。
    * **具体工作**:
        * 创建一个独立的模块或类，它的功能很简单：接收一个Prompt文本，向LLM的API地址发送请求，然后返回LLM生成的文本。
        * 这样做的好处是**解耦**：如果未来需要更换LLM模型，你只需要修改这一个模块，而你的核心仿真逻辑（模块一、二、三）完全不受影响。

* **4.3 实现结果记录与查询服务 (Results Logging & Query Service)**
    * **职责**: 将仿真过程中的重要数据实时记录下来，并为前端的各种可视化图表提供专属的数据查询接口。
    * **具体工作**:
        * **过程记录 (Logger)**:
            * [cite_start]在每个Agent的状态更新后，记录下它的新状态（情绪、立场、置信度）以及是哪篇帖子导致了这次更新 [cite: 184-185]。
            * [cite_start]记录下Agent生成的每一篇新帖子 [cite: 186]。
            * 将所有日志以结构化的格式（如JSON Lines或写入数据库）保存。
        * **可视化查询API (Query Service)**:
            * 为前端的每一个图表（如热度直方图、群体情态图、词云、Agent个体演化图、转播树等）提供定制化的查询API，直接返回图表所需格式的数据，将计算压力留在后端。

* **4.4 实现仿真状态持久化服务 (Simulation State Persistence Service)**
    * **职责**: 允许用户保存和加载整个仿真的状态，以支持迭代式分析。
    * **具体工作**:
        * **保存状态API**: 提供一个接口，可以将当前仿真的完整状态（包括所有Agent的状态、帖子池、时间片进度等）序列化并保存为文件。
        * **加载状态API**: 提供一个接口，可以从之前的存档文件中恢复仿真，让用户可以在此基础上调整参数并继续运行。

* **环境配置API**：允许前端设置仿真起止时间、初始规模、舆论偏向、事件描述等参数。
* **数据预处理**：根据用户设定的参数，筛选、采样原始数据，调整初始信息池的构成。
* **Prompt上下文注入**：每次Agent调用LLM时，自动将事件描述等环境信息注入Prompt，确保Agent行为与环境设定一致。

---

### **模块五：交互式可视化服务 (Interactive Visualization Service)**

这是你的"数据分析中心"，为用户提供丰富的交互式数据探索和分析功能。

* **5.1 时间刷选交互 (Time Brush Interaction)**
    * **职责**: 支持用户通过时间轴刷选特定时间段的数据进行分析。
    * **具体工作**:
        * 实现时间范围筛选API，支持ISO格式时间戳的精确筛选。
        * 提供时间轴数据接口，返回所有可用时间戳供前端渲染。
        * 支持实时时间刷选，用户调整时间范围时立即更新数据展示。

* **5.2 关键词搜索功能 (Keyword Search)**
    * **职责**: 支持用户通过关键词搜索帖子内容。
    * **具体工作**:
        * 实现多字段搜索（帖子内容、作者ID、帖子ID等）。
        * 支持多关键词组合搜索，计算匹配度评分。
        * 提供搜索结果排序和分页功能。

* **5.3 排序和筛选功能 (Sorting and Filtering)**
    * **职责**: 支持多种排序方式和筛选条件。
    * **具体工作**:
        * 实现多种排序方式：按时间、热度、点赞数、分享数等。
        * 支持热度阈值筛选，过滤低质量内容。
        * 提供内容类型筛选：全部、原创、转发、事件帖子。

* **5.4 转发内容控制 (Repost Content Control)**
    * **职责**: 允许用户控制是否显示转发内容。
    * **具体工作**:
        * 实现转发内容开关，默认隐藏转发内容。
        * 支持用户手动控制转发内容的显示。
        * 提供信息密度调节功能。

* **5.5 摘要统计功能 (Summary Statistics)**
    * **职责**: 提供全面的数据摘要和统计信息。
    * **具体工作**:
        * 生成热度统计：总点赞、总分享、平均热度等。
        * 提供类型分布统计：原创、转发、事件帖子的数量分布。
        * 识别热门话题和活跃作者。
        * 支持不同时间段的统计对比。

* **5.6 转播树可视化 (Repost Tree Visualization)**

    * **功能**: 展示信息扩散的层级结构，直观反映转发传播路径。
    * **数据结构要求**: 每条帖子需包含 parent_post_id 字段（原帖为 null，转发帖为被转发帖的 id）。
    * **后端实现**:
        * 仿真过程中，所有转发帖需写入 parent_post_id。
        * 新增 API `/api/visualization/posts/repost_tree`，返回树形嵌套 JSON。
        * 后端算法：遍历所有帖子，按 parent_post_id 组织成树，根节点为虚拟节点，所有 parent_post_id 为 null 的为一级子节点。
    * **Agent发帖parent_post_id判据**：
        * 每个Agent在每个时间片内，浏览个性化信息流时，会为每条帖子计算一个"多因素加权分数"：
          `score = 0.5 * |emotion_change| + 0.3 * |confidence_change| + 0.2 * base_impact`
        * 该分数综合反映了情绪波动、置信度变化和外部刺激强度。
        * Agent发帖时，其新帖的parent_post_id会被设置为本时间片内分数最高的那条帖子ID，实现"对影响最大的帖子进行回复/评论"。
        * 这样，Agent的发言会自然嵌入传播树结构，真实反映其在扩散链条中的作用。
    * **前端集成建议**: 前端可用 D3.js 等库渲染树形结构，支持节点高亮、层级展开等交互。

---

## 分工契约说明（协作蓝图）

### Agent设计师（"演员"）职责

* 实现独立、可测试的Agent类，封装所有个体决策与状态逻辑。
* 必须提供如下接口：
    1.  `__init__(agent_config)`: 初始化角色，支持性格建模（如is\_firm\_stance等）。
    2.  `update_state(post_object, llm_service=None)`: 状态更新，需调用LLM分析情绪，按性格规则更新立场，管理黑名单。
    3.  `generate_action_prompt()`: 行动决策，返回Prompt或None。
    4.  `agent_id/agent_type/stance/interests/blacklist`等属性，供后端读取。
* 只需保证接口契约，内部实现细节自定。

### 后端逻辑开发者（"总导演"）职责

* 负责主流程编排、时间片推进、Agent调度、信息流筛选、外部服务对接。
* 需实现如下算法/逻辑：
    1.  行动顺序调度算法：按优先级分组依次调度Agent。
    2.  **环境摘要生成算法**：为意见领袖汇总当前时间片的宏观舆情信息。
    3.  **个性化信息流筛选算法**：多重过滤（热度、立场相似度、兴趣、黑名单）。
    4.  Agent接口调用逻辑：喂帖子、问发言、调用LLM生成内容、更新世界。
    5.  **提供面向前端的服务接口**：
        * 完整的仿真配置API（环境、Agent增删改查）。
        * 面向所有可视化图表的、结构化的数据查询API。
        * 仿真状态的保存与加载API。
        * **交互式可视化API**：时间刷选、关键词搜索、排序筛选、摘要统计。
* 依赖Agent类的接口，需与Agent设计师保持接口文档同步。

---

### **总结：你的工作蓝图**

你的工作是搭建一个强大的、模块化的仿真平台。你需要管理时间的流动，维护世界的状态，调度每一个角色的行动，并连接外部的服务。你为所有Agent提供了一个表演的舞台，并确保它们的每一次表演都被精确地记录下来。这个平台的好坏，直接决定了整个研究能否顺利进行和复现。

## 用户可操作功能

本系统支持用户通过前端或API灵活配置仿真环境、Agent参数、过程干预与结果查询，具体包括：

### 1. 仿真环境配置
- **起止时间设置**：用户可设定仿真的起始和结束时间，后端据此筛选原始数据，构建初始信息池。
- **初始规模与舆论偏向**：用户可设定初始帖子池的规模，以及各立场、情感倾向的比例。后端根据参数调整初始帖子被选中的概率，实现带有特定偏见的初始讨论氛围。
- **事件自然语言描述**：用户可为事件输入自然语言描述，作为全体Agent的公共背景信息。后端在每次Agent调用LLM决策时，将该描述注入Prompt上下文，确保Agent行为受其持续影响。

### 2. Agent配置
- 支持用户通过前端/接口增删改查Agent类型、参数、初始状态等。

### 3. 仿真过程干预与控制
- 支持用户在仿真过程中插入突发事件、调整参数、暂停/恢复仿真等。

#### 3.1 启动仿真API
- **功能**：提供启动仿真的API接口，前端点击"Simulate"按钮时调用
- **接口设计**：`POST /api/simulation/start`，接收环境和Agent配置，启动后台仿真计算
- **流程**：用户配置完成后点击启动，后端开始长时间运算，用户等待结果展示

#### 3.2 突发事件注入机制
- **注入时机**：
  - **仿真开始前**：用户在配置阶段的时间线上右键点击时间点，输入突发新闻内容，作为初始配置的一部分
  - **两次仿真之间**：用户查看第一次仿真结果后，在结果可视化界面上选择时间点注入新事件，触发全新仿真进行对比分析
- **接口设计**：`POST /api/simulation/inject_event`，支持预设事件和动态注入
- **实现逻辑**：事件在对应时间片自动处理，确保所有Agent接收到相关信息

#### 3.3 仿真结果加载与复用
- **功能**：支持加载历史仿真结果进行迭代分析和对比

### 4. 结果可视化交互 (Interactive Visualization of Results)

在数据展示和分析阶段，用户有丰富的交互手段来探索和分析仿真结果。

#### 4.1 时间刷选功能
- **功能**：通过时间轴刷选，筛选和分析特定时间段的数据
- **接口设计**：`POST /api/visualization/posts/filter`，支持时间范围参数
- **前端交互**：用户可通过拖拽时间轴来调整分析的时间范围
- **实时更新**：时间范围变化时，相关图表和数据立即更新

#### 4.2 关键词搜索功能
- **功能**：通过关键词搜索帖子内容
- **接口设计**：`POST /api/visualization/posts/search`，支持多字段搜索
- **搜索范围**：帖子内容、作者ID、帖子ID等
- **匹配度评分**：返回搜索结果的相关性评分

#### 4.3 排序和筛选功能
- **功能**：调整结果的排序和过滤方式
- **排序选项**：按时间、热度、点赞数、分享数等
- **筛选条件**：热度阈值、内容类型等
- **接口设计**：通过`sort_by`、`min_popularity`、`filter_type`等参数控制

#### 4.4 转发内容控制
- **功能**：控制是否显示转发内容
- **默认设置**：转发内容默认隐藏
- **用户控制**：用户可手动开启/关闭转发内容显示
- **信息密度调节**：通过控制转发内容来调节信息密度

#### 4.5 摘要统计功能
- **功能**：提供全面的数据摘要和统计信息
- **统计内容**：热度统计、类型分布、热门话题、活跃作者等
- **接口设计**：`POST /api/visualization/posts/summary`
- **时间段对比**：支持不同时间段的统计对比分析

#### 4.6 综合分析功能
- **功能**：支持多种筛选条件的组合使用
- **组合方式**：时间范围 + 关键词搜索 + 热度筛选 + 排序
- **灵活配置**：用户可根据需要组合不同的筛选条件
- **结果展示**：提供筛选参数回显和结果统计